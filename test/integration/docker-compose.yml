services:
  bind9:
    # ISC BIND9 official image â€” runs named as root (-g = foreground).
    image: internetsystemsconsortium/bind9:9.18
    # Seed the zone file into the writable cache dir before starting named.
    entrypoint:
      - /bin/sh
      - -c
      - >
        chown -R bind:bind /var/cache/bind &&
        cp /seed/db.example.com /var/cache/bind/db.example.com &&
        chown bind:bind /var/cache/bind/db.example.com &&
        exec named -g -u bind -c /etc/bind/named.conf
    ports:
      - "127.0.0.1:5354:53/tcp"
      - "127.0.0.1:5354:53/udp"
    volumes:
      - ./bind9/named.conf:/etc/bind/named.conf:ro
      - ./bind9/db.example.com:/seed/db.example.com:ro
      - bind9-cache:/var/cache/bind
    healthcheck:
      test: ["CMD-SHELL", "dig @127.0.0.1 SOA example.com +short | grep -q 'ns1.example.com'"]
      interval: 2s
      timeout: 5s
      retries: 20
      start_period: 3s

volumes:
  bind9-cache:
