services:
  bind9:
    # ISC BIND9 official image â€” runs named as root (-g = foreground).
    image: internetsystemsconsortium/bind9:9.18
    # Seed the zone file into the writable cache dir before starting named.
    entrypoint:
      - /bin/sh
      - -c
      - >
        chown -R bind:bind /var/cache/bind &&
        cp /seed/db.example.com /var/cache/bind/db.example.com &&
        chown bind:bind /var/cache/bind/db.example.com &&
        exec named -g -u bind -c /etc/bind/named.conf
    ports:
      - "127.0.0.1:5354:53/tcp"
      - "127.0.0.1:5354:53/udp"
    volumes:
      - ./bind9/named.conf:/etc/bind/named.conf:ro
      - ./bind9/db.example.com:/seed/db.example.com:ro
      - bind9-cache:/var/cache/bind
    healthcheck:
      test: ["CMD-SHELL", "dig @127.0.0.1 SOA example.com +short | grep -q 'ns1.example.com'"]
      interval: 2s
      timeout: 5s
      retries: 20
      start_period: 3s

  external-dns-docker:
    # Build from the project root so we test the real binary.
    build:
      context: ../..
      dockerfile: Dockerfile
    # Run as root so the daemon can open /var/run/docker.sock.
    # This is acceptable for a local integration-test environment.
    user: "0:0"
    command:
      - --rfc2136-host=bind9
      - --rfc2136-zone=example.com
      - --rfc2136-tsig-key=external-dns-test
      - --rfc2136-tsig-secret=dGVzdC1rZXktZm9yLWV4dGVybmFsLWRucy1kb2NrZXI=
      - --rfc2136-tsig-alg=hmac-sha256
      # Short interval and debounce so tests don't need to wait long.
      - --interval=30s
      - --debounce=500ms
      - --log-level=debug
    volumes:
      # Share the host Docker socket so the daemon can watch test containers.
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      bind9:
        condition: service_healthy
    restart: on-failure

volumes:
  bind9-cache:
